# 토스페이먼츠 결제위젯 v2 무통장입금 테스트 가이드

## 1. 환경 설정

### 1.1 환경변수 설정

`.env` 파일에 다음 내용이 설정되어 있는지 확인하세요:

```env
# 토스페이먼츠 설정 (테스트 환경)
NEXT_PUBLIC_TOSS_CLIENT_KEY=test_ck_Z1aOwX7K8mzBbD5xNq703yQxzvNP
TOSS_SECRET_KEY=test_sk_AQ92ymxN34vE9EzPpQ14rajRKXvd
```

### 1.2 개발 서버 실행

```bash
npm run dev
```

## 2. 토스페이먼츠 결제위젯 v2 무통장입금 테스트 플로우

### 2.1 결제 요청 단계

1. 브라우저에서 `http://localhost:3000` 접속
2. "무통장입금" 선택
3. "결제하기" 버튼 클릭
4. 토스페이먼츠 결제위젯 v2가 열림

### 2.2 가상계좌 발급 단계

1. 결제위젯에서 "무통장입금" 선택
2. 결제 완료 버튼 클릭
3. **중요**: 이 단계에서 실제 결제는 완료되지 않음
4. 가상계좌 정보가 발급됨 (은행, 계좌번호, 입금기한)

### 2.3 토스페이먼츠 개발자센터 확인

1. [토스페이먼츠 개발자센터](https://developers.tosspayments.com/) 접속
2. 로그인 후 "결제내역" 메뉴 클릭
3. 방금 생성된 결제 건 확인
4. **결제수단**이 "가상계좌"로 표시되어야 함
5. **상태**가 "입금대기"로 표시되어야 함

### 2.4 입금처리 테스트

1. 결제내역에서 해당 건 클릭
2. **"입금처리" 버튼**이 나타나야 함
3. "입금처리" 버튼 클릭
4. 상태가 "입금완료"로 변경됨

## 3. 문제 해결

### 3.1 "입금처리" 버튼이 안 나타나는 경우

#### 원인 1: 결제수단이 올바르게 설정되지 않음

- **확인사항**: 결제내역에서 결제수단이 "가상계좌"로 표시되는지 확인
- **해결방법**: `src/components/PaymentButton.tsx`의 `virtualAccount` 설정 확인

#### 원인 2: API 키 문제

- **확인사항**: 환경변수가 올바르게 로드되는지 확인
- **해결방법**: 브라우저 콘솔에서 API 키 로그 확인

#### 원인 3: 요청 데이터 구조 문제

- **확인사항**: 토스페이먼츠 결제위젯 v2 API 형식에 맞는지 확인
- **해결방법**: `amount` 객체 구조와 `virtualAccount` 설정 확인

### 3.2 결제내역에 안 나타나는 경우

#### 원인 1: API 키 오류

- **확인사항**: `TOSS_SECRET_KEY`가 올바른지 확인
- **해결방법**: 테스트 키 사용 확인

#### 원인 2: 요청 실패

- **확인사항**: 브라우저 네트워크 탭에서 API 요청 상태 확인
- **해결방법**: 서버 로그에서 오류 메시지 확인

#### 원인 3: 환경변수 미로드

- **확인사항**: 서버 재시작 후 환경변수 로드 확인
- **해결방법**: `.env.local` 파일 경로와 내용 확인

## 4. 디버깅 방법

### 4.1 브라우저 콘솔 확인

```javascript
// API 키 확인
console.log("Client Key:", process.env.NEXT_PUBLIC_TOSS_CLIENT_KEY);

// 결제 요청 데이터 확인
console.log("Payment Request Data:", paymentRequestData);
```

### 4.2 서버 로그 확인

```bash
# 개발 서버 로그에서 확인할 내용
- API 키 로드 상태
- 토스페이먼츠 API 요청/응답
- 오류 메시지
```

### 4.3 네트워크 탭 확인

1. 브라우저 개발자도구 → Network 탭
2. `/api/payments/request` 요청 확인
3. 요청/응답 데이터 확인

## 5. 정상 동작 확인 체크리스트

- [ ] 환경변수 `.env.local` 파일 생성
- [ ] 개발 서버 재시작
- [ ] 무통장입금 선택 후 결제 요청
- [ ] 토스페이먼츠 개발자센터에서 결제내역 확인
- [ ] 결제수단이 "가상계좌"로 표시
- [ ] 상태가 "입금대기"로 표시
- [ ] "입금처리" 버튼 표시
- [ ] 입금처리 후 상태 변경 확인

## 6. 추가 참고사항

### 6.1 토스페이먼츠 공식 문서

- [결제위젯 v2 React 연동 가이드](https://docs.tosspayments.com/guides/v2/payment-widget/integration?frontend=react)
- [무통장입금 연동 가이드](https://docs.tosspayments.com/guides/v2/payment-window/integration-virtual-account)
- [API 레퍼런스](https://docs.tosspayments.com/reference)

### 6.2 테스트 환경 제한사항

- 테스트 환경에서는 실제 입금이 발생하지 않음
- 가상계좌는 테스트용으로만 사용 가능
- 실제 운영 환경에서는 별도 설정 필요

### 6.3 웹훅 설정 (선택사항)

- 실제 운영 환경에서는 웹훅을 통한 자동 상태 업데이트 권장
- 테스트 환경에서는 수동 입금처리로 충분
